<!DOCTYPE html>
<html>
<head lang="ko">
    <meta charset="UTF-8">
    <title>Volume Rendering Cloud System</title>
    <link rel='stylesheet' href='/stylesheets/default.css' />
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src='http://cdn.binaryjs.com/0/binary.js'></script>
    <script src='http://localhost:3000/socket.io/socket.io.js'></script>
    <script src='/javascripts/jquery-1.11.1.min.js'></script>
</head>
<body>

<header class="template_header">
    <h1>Volume Stream</h1>
</header>

<section class="template_section">
    <article>
        <a href="/" class="default_a">Main</a>
        <a href="/volume" class="default_a">Volume List</a>

        <input type="file" id="fileinput" accept="image/*" capture="camera" />

        <div id="view_port" class="default_stream">

        </div>

        <div class="default_error">
        <% if( error != '') { %>
            <%=error%>
        <% }%>
        </div>
    </article>
</section>

<footer class="template_footer">
    <span>Copyright(c) Wong.Lee Francis.kim  All rights reserved</span>
</footer>
    <script type="text/javascript">
        var socket = io.connect('http://localhost:3000'); // Socket.io
        var client = new BinaryClient('ws://' + document.location.host); // Byte streaming
        var accessInfo = {
            volumeIndex : '<%=accessInfo.volumeIndex%>',
            userPn : '<%=accessInfo.userPn%>'
        };
        // ~ init room setting
        console.log('accessInfo: ',accessInfo);

        var joinSocket = function(){
            console.log('Request join socket')
            socket.emit('join', { room : accessInfo.volumeIndex } );
        };

        joinSocket();

        socket.on('message', function(data){
            if(!data.success){
                console.log(data.error);
                $('.default_error').append('<p>'+data.error+'</p>')
                setTimeout(joinSocket, 1000);
                return;
            }
            // ~ success
            $('.default_error').html('');
            var buffer = new ArrayBuffer(4);
            var dataView = new DataView(buffer);

            dataView.setInt32(0, accessInfo.volumeIndex);
            console.log(dataView.getInt32(0));
            client.send(buffer);
        });

        client.on('stream', function(stream, meta){

            // collect stream data
            var parts = [];
            stream.on('data', function(data){
                parts.push(data);
            });

            // when finished, set it as the background image
            stream.on('end', function(){
                console.log(stream.id);
                var url = (window.URL || window.webkitURL).createObjectURL(new Blob(parts));
                document.getElementById('view_port').style.backgroundImage = 'url(' + url + ')';
                document.getElementById('view_port').style.backgroundRepeat = 'no-repeat';
            });
        });

    </script>
</body>
</html>
